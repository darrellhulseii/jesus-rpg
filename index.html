<!DOCTYPE html>
<html>
<head>
    <title>The Seven Heavenly Virtues</title>
    <style>
        body { 
            margin: 0; 
            background: #1a1a2e; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            font-family: 'Courier New', monospace; 
            color: #eee; 
            flex-direction: column;
            padding: 20px;
        }
        canvas { 
            image-rendering: pixelated; 
            image-rendering: crisp-edges;
            border: 3px solid #16213e; 
            background: #0f0f0f; 
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        #info { 
            margin-top: 15px; 
            text-align: center; 
            max-width: 600px;
            background: #16213e;
            padding: 15px;
            border-radius: 5px;
            line-height: 1.6;
        }
        #info strong { color: #f39c12; }
        
        #gameboy-controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            pointer-events: none;
            z-index: 1000;
        }
        
        #dpad-container {
            position: relative;
            width: 120px;
            height: 120px;
            pointer-events: all;
        }
        
        .dpad-btn {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #2c3e50;
            border: 3px solid #1a252f;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ecf0f1;
            font-size: 20px;
            font-weight: bold;
            user-select: none;
            touch-action: none;
            cursor: pointer;
            transition: all 0.05s;
        }
        
        .dpad-btn:active { background: #34495e; transform: scale(0.95); }
        .dpad-btn.up { top: 0; left: 40px; border-radius: 8px 8px 0 0; }
        .dpad-btn.down { bottom: 0; left: 40px; border-radius: 0 0 8px 8px; }
        .dpad-btn.left { top: 40px; left: 0; border-radius: 8px 0 0 8px; }
        .dpad-btn.right { top: 40px; right: 0; border-radius: 0 8px 8px 0; }
        .dpad-btn.center { top: 40px; left: 40px; background: #1a252f; cursor: default; }
        
        #button-container { display: flex; flex-direction: column; gap: 15px; pointer-events: all; }
        #ab-buttons { display: flex; gap: 15px; align-items: center; }
        
        .game-btn {
            width: 65px;
            height: 65px;
            background: #e74c3c;
            border: 4px solid #c0392b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 20px;
            font-weight: bold;
            user-select: none;
            touch-action: none;
            cursor: pointer;
            transition: all 0.05s;
            box-shadow: 0 4px 0 #a93226;
        }
        
        .game-btn:active { background: #c0392b; transform: translateY(2px); box-shadow: 0 2px 0 #a93226; }
        .game-btn.b-btn { background: #95a5a6; border-color: #7f8c8d; box-shadow: 0 4px 0 #6c7a7b; }
        .game-btn.b-btn:active { background: #7f8c8d; box-shadow: 0 2px 0 #6c7a7b; }
        
        .start-btn {
            width: 70px;
            height: 30px;
            background: #34495e;
            border: 3px solid #2c3e50;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ecf0f1;
            font-size: 11px;
            font-weight: bold;
            user-select: none;
            touch-action: none;
            cursor: pointer;
            transition: all 0.05s;
            margin: 0 auto;
        }
        
        .start-btn:active { background: #2c3e50; transform: scale(0.95); }
        
        #quote-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        #quote-box {
            background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
            border: 3px solid #f39c12;
            border-radius: 15px;
            padding: 25px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }
        
        #quote-text { font-size: 14px; line-height: 1.5; color: #ecf0f1; margin-bottom: 15px; }
        #quote-author { font-size: 12px; color: #f39c12; font-weight: bold; margin-bottom: 20px; }
        
        #quote-continue {
            background: #f39c12;
            color: #1a252f;
            border: none;
            padding: 10px 25px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #quote-continue:active { background: #e67e22; transform: scale(0.95); }
        
        @media (max-width: 768px), (pointer: coarse) {
            #gameboy-controls { display: flex; }
            body { padding: 10px 10px 180px 10px; }
        }
    </style>
</head>
<body>
    <canvas id="game" width="512" height="384"></canvas>
    <div id="info">
        <strong>Controls:</strong> WASD/Arrows to move | <strong>Battle:</strong> ↑↓ select, Enter/Z confirm, Esc/X back<br>
        <strong>Start/I:</strong> Open inventory | Defeat the Seven Deadly Sins!
    </div>
    
    <div id="gameboy-controls">
        <div id="dpad-container">
            <div class="dpad-btn up" data-key="arrowup">▲</div>
            <div class="dpad-btn down" data-key="arrowdown">▼</div>
            <div class="dpad-btn left" data-key="arrowleft">◀</div>
            <div class="dpad-btn right" data-key="arrowright">▶</div>
            <div class="dpad-btn center"></div>
        </div>
        <div id="button-container">
            <div id="ab-buttons">
                <div class="game-btn b-btn" data-key="b">B</div>
                <div class="game-btn" data-key="a">A</div>
            </div>
            <div class="start-btn" data-key="start">START</div>
        </div>
    </div>
    
    <div id="quote-overlay">
        <div id="quote-box">
            <div id="quote-text"></div>
            <div id="quote-author"></div>
            <button id="quote-continue">Continue Quest</button>
        </div>
    </div>
    
    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        const TILE_SIZE = 16;
        const SCALE = 2;
        const VIEW_WIDTH = canvas.width / SCALE;
        const VIEW_HEIGHT = canvas.height / SCALE;
        const MAP_WIDTH = 50;
        const MAP_HEIGHT = 40;

        let gameState = 'title';
        let hudMsg = '';
        let hudMsgTimer = 0;
        let dungeonLevel = 1;

        const titleScreenVerses = [
            { text: "Death has been swallowed up in victory. Where, O death, is your victory? Where, O death, is your sting?", reference: "1 Corinthians 15:54-55" },
            { text: "For the wages of sin is death, but the gift of God is eternal life in Christ Jesus our Lord.", reference: "Romans 6:23" },
            { text: "He will wipe every tear from their eyes. There will be no more death or mourning or crying or pain.", reference: "Revelation 21:4" },
            { text: "The last enemy to be destroyed is death. For he has put everything under his feet.", reference: "1 Corinthians 15:26-27" },
            { text: "Since the children have flesh and blood, he too shared in their humanity so that by his death he might break the power of him who holds the power of death—that is, the devil.", reference: "Hebrews 2:14" }
        ];
        
        let currentVerseIndex = 0;
        let verseTimer = 0;
        const VERSE_DISPLAY_TIME = 6;

        // SPRITE GENERATION
        function createTileSprite(type) {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            
            if (type === 'floor') {
                const shade = 40 + Math.random() * 20;
                cx.fillStyle = `rgb(${shade}, ${shade}, ${shade + 5})`;
                cx.fillRect(0, 0, TILE_SIZE, TILE_SIZE);
                for (let i = 0; i < 8; i++) {
                    cx.fillStyle = `rgba(${30 + Math.random() * 20}, ${30 + Math.random() * 20}, ${35 + Math.random() * 20}, 0.3)`;
                    cx.fillRect(Math.random() * TILE_SIZE, Math.random() * TILE_SIZE, 2, 2);
                }
            } else if (type === 'wall') {
                const baseColor = 60 + Math.random() * 15;
                cx.fillStyle = `rgb(${baseColor}, ${baseColor - 5}, ${baseColor - 10})`;
                cx.fillRect(0, 0, TILE_SIZE, TILE_SIZE);
                cx.strokeStyle = `rgba(0, 0, 0, 0.4)`;
                cx.lineWidth = 1;
                cx.strokeRect(0, 0, TILE_SIZE, TILE_SIZE);
            }
            return c;
        }

        function createPlayerSprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#2c3e50';
            cx.fillRect(5, 8, 6, 7);
            cx.fillStyle = '#f0c291';
            cx.fillRect(6, 4, 4, 4);
            cx.fillStyle = '#3e2723';
            cx.fillRect(6, 3, 4, 1);
            cx.fillStyle = '#5d4037';
            cx.fillRect(7, 5, 1, 1);
            cx.fillRect(9, 5, 1, 1);
            cx.fillStyle = '#8d6e63';
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createStMichaelSprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#fff';
            cx.fillRect(3, 7, 2, 4);
            cx.fillRect(11, 7, 2, 4);
            cx.fillStyle = '#3498db';
            cx.fillRect(5, 8, 6, 7);
            cx.fillStyle = '#f0c291';
            cx.fillRect(6, 4, 4, 4);
            cx.fillStyle = '#8B4513';
            cx.fillRect(6, 3, 4, 1);
            cx.fillStyle = '#000';
            cx.fillRect(7, 5, 1, 1);
            cx.fillRect(9, 5, 1, 1);
            cx.strokeStyle = '#f39c12';
            cx.lineWidth = 1;
            cx.beginPath();
            cx.arc(8, 2, 3, 0, Math.PI * 2);
            cx.stroke();
            cx.fillStyle = '#95a5a6';
            cx.fillRect(11, 10, 2, 5);
            cx.fillStyle = '#e74c3c';
            cx.fillRect(2, 9, 3, 4);
            cx.fillStyle = '#f39c12';
            cx.fillRect(3, 10, 1, 2);
            cx.fillStyle = '#2c3e50';
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createStJoanSprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#95a5a6';
            cx.fillRect(5, 8, 6, 7);
            cx.fillStyle = '#bdc3c7';
            cx.fillRect(6, 9, 1, 3);
            cx.fillStyle = '#f0c291';
            cx.fillRect(6, 4, 4, 4);
            cx.fillStyle = '#8B4513';
            cx.fillRect(6, 3, 4, 2);
            cx.fillStyle = '#000';
            cx.fillRect(7, 5, 1, 1);
            cx.fillRect(9, 5, 1, 1);
            cx.fillStyle = '#8B4513';
            cx.fillRect(11, 6, 1, 10);
            cx.fillStyle = '#e74c3c';
            cx.fillRect(11, 5, 2, 2);
            cx.fillStyle = '#7f8c8d';
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createStVincentSprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#000';
            cx.fillRect(4, 8, 8, 7);
            cx.fillStyle = '#f5f5f5';
            cx.fillRect(5, 9, 6, 6);
            cx.fillStyle = '#f0c291';
            cx.fillRect(6, 4, 4, 4);
            cx.fillStyle = '#5D4037';
            cx.fillRect(6, 3, 4, 1);
            cx.fillRect(6, 3, 1, 2);
            cx.fillRect(9, 3, 1, 2);
            cx.fillStyle = '#000';
            cx.fillRect(7, 5, 1, 1);
            cx.fillRect(9, 5, 1, 1);
            cx.fillStyle = '#8B4513';
            cx.fillRect(3, 4, 1, 11);
            cx.fillRect(2, 4, 2, 1);
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createEnemySprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#e74c3c';
            cx.fillRect(6, 8, 4, 6);
            cx.fillStyle = '#8b6f47';
            cx.fillRect(6, 4, 4, 4);
            cx.fillStyle = '#f39c12';
            cx.fillRect(7, 5, 1, 1);
            cx.fillRect(9, 5, 1, 1);
            cx.fillStyle = '#34495e';
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createDevilSprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#8B0000';
            cx.fillRect(5, 8, 6, 7);
            cx.fillStyle = '#CD0000';
            cx.fillRect(6, 4, 4, 4);
            cx.fillStyle = '#4a0000';
            cx.fillRect(5, 3, 2, 2);
            cx.fillRect(9, 3, 2, 2);
            cx.fillStyle = '#ff0';
            cx.fillRect(7, 5, 1, 1);
            cx.fillRect(9, 5, 1, 1);
            cx.fillStyle = '#8B0000';
            cx.fillRect(11, 10, 1, 3);
            cx.fillRect(12, 12, 1, 2);
            cx.fillStyle = '#000';
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createPrideSprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#9b59b6';
            cx.fillRect(5, 8, 6, 7);
            cx.fillStyle = '#f0c291';
            cx.fillRect(6, 4, 4, 4);
            cx.fillStyle = '#f39c12';
            cx.fillRect(5, 2, 6, 2);
            cx.fillRect(6, 1, 1, 1);
            cx.fillRect(8, 1, 1, 1);
            cx.fillRect(10, 1, 1, 1);
            cx.fillStyle = '#000';
            cx.fillRect(7, 5, 1, 1);
            cx.fillRect(9, 5, 1, 1);
            cx.fillStyle = '#8e44ad';
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createGreedSprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#f39c12';
            cx.fillRect(5, 8, 6, 7);
            cx.fillStyle = '#f0c291';
            cx.fillRect(6, 4, 4, 4);
            cx.fillStyle = '#000';
            cx.fillRect(7, 5, 1, 1);
            cx.fillRect(9, 5, 1, 1);
            cx.fillStyle = '#8B4513';
            cx.fillRect(3, 9, 3, 4);
            cx.fillStyle = '#f39c12';
            cx.fillRect(3, 10, 1, 1);
            cx.fillRect(4, 11, 1, 1);
            cx.fillStyle = '#d68910';
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createLustSprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#e91e63';
            cx.fillRect(5, 8, 6, 7);
            cx.fillStyle = '#f0c291';
            cx.fillRect(6, 4, 4, 4);
            cx.fillStyle = '#ad1457';
            cx.fillRect(6, 3, 4, 1);
            cx.fillStyle = '#000';
            cx.fillRect(7, 5, 1, 1);
            cx.fillRect(9, 5, 1, 1);
            cx.fillStyle = '#ff1744';
            cx.fillRect(3, 10, 2, 1);
            cx.fillRect(2, 11, 1, 1);
            cx.fillRect(4, 11, 1, 1);
            cx.fillRect(2, 12, 3, 1);
            cx.fillStyle = '#c2185b';
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createEnvySprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#27ae60';
            cx.fillRect(5, 8, 6, 7);
            cx.fillStyle = '#8BC34A';
            cx.fillRect(6, 4, 4, 4);
            cx.fillStyle = '#1e8449';
            cx.fillRect(6, 3, 4, 1);
            cx.fillStyle = '#ff0';
            cx.fillRect(7, 5, 1, 1);
            cx.fillRect(9, 5, 1, 1);
            cx.fillStyle = '#1e8449';
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createGluttonySprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#e67e22';
            cx.fillRect(4, 8, 8, 7);
            cx.fillStyle = '#f0c291';
            cx.fillRect(6, 4, 4, 4);
            cx.fillStyle = '#d35400';
            cx.fillRect(6, 3, 4, 1);
            cx.fillStyle = '#000';
            cx.fillRect(7, 5, 1, 1);
            cx.fillRect(9, 5, 1, 1);
            cx.fillRect(7, 7, 2, 1);
            cx.fillStyle = '#ca6f1e';
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createWrathSprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#c0392b';
            cx.fillRect(5, 8, 6, 7);
            cx.fillStyle = '#e74c3c';
            cx.fillRect(6, 4, 4, 4);
            cx.fillStyle = '#922b21';
            cx.fillRect(6, 3, 4, 1);
            cx.fillStyle = '#ff0';
            cx.fillRect(7, 5, 1, 1);
            cx.fillRect(9, 5, 1, 1);
            cx.fillStyle = '#000';
            cx.fillRect(7, 4, 1, 1);
            cx.fillRect(9, 4, 1, 1);
            cx.fillStyle = '#a93226';
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createSlothSprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#95a5a6';
            cx.fillRect(5, 9, 6, 6);
            cx.fillStyle = '#bdc3c7';
            cx.fillRect(6, 5, 4, 4);
            cx.fillStyle = '#7f8c8d';
            cx.fillRect(6, 4, 4, 1);
            cx.fillStyle = '#000';
            cx.fillRect(7, 6, 1, 1);
            cx.fillRect(9, 6, 1, 1);
            cx.fillRect(7, 7, 2, 1);
            cx.fillStyle = '#7f8c8d';
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createDemonSprite() {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            cx.fillStyle = '#8B0000';
            cx.fillRect(6, 8, 4, 6);
            cx.fillStyle = '#CD0000';
            cx.fillRect(6, 4, 4, 4);
            cx.fillStyle = '#4a0000';
            cx.fillRect(6, 3, 1, 1);
            cx.fillRect(9, 3, 1, 1);
            cx.fillStyle = '#ff0';
            cx.fillRect(7, 5, 1, 1);
            cx.fillRect(9, 5, 1, 1);
            cx.fillStyle = '#000';
            cx.fillRect(6, 14, 2, 2);
            cx.fillRect(8, 14, 2, 2);
            return c;
        }

        function createItemSprite(type) {
            const c = document.createElement('canvas');
            c.width = c.height = TILE_SIZE;
            const cx = c.getContext('2d');
            
            if (type === 'holyWater') {
                cx.fillStyle = '#3498db';
                cx.fillRect(6, 7, 4, 7);
                cx.fillRect(7, 5, 2, 2);
                cx.fillStyle = '#fff';
                cx.fillRect(7, 8, 1, 2);
            } else if (type === 'rosary') {
                cx.fillStyle = '#8b4513';
                for (let i = 0; i < 5; i++) {
                    cx.fillRect(6 + i, 6 + i, 2, 2);
                }
            } else if (type === 'gold') {
                cx.fillStyle = '#f39c12';
                cx.beginPath();
                cx.arc(8, 8, 3, 0, Math.PI * 2);
                cx.fill();
            }
            
            return c;
        }

        const sprites = {
            floors: Array(10).fill().map(() => createTileSprite('floor')),
            walls: Array(10).fill().map(() => createTileSprite('wall')),
            player: createPlayerSprite(),
            stMichael: createStMichaelSprite(),
            stJoan: createStJoanSprite(),
            stVincent: createStVincentSprite(),
            enemy: createEnemySprite(),
            devil: createDevilSprite(),
            pride: createPrideSprite(),
            greed: createGreedSprite(),
            lust: createLustSprite(),
            envy: createEnvySprite(),
            gluttony: createGluttonySprite(),
            wrath: createWrathSprite(),
            sloth: createSlothSprite(),
            demon: createDemonSprite(),
            holyWater: createItemSprite('holyWater'),
            rosary: createItemSprite('rosary'),
            gold: createItemSprite('gold')
        };

        // BATTLE BACKGROUNDS
        const battleBackgrounds = { grass: null, desert: null, dungeon: null };

        function createBattleBackground(type) {
            const c = document.createElement('canvas');
            c.width = VIEW_WIDTH;
            c.height = VIEW_HEIGHT;
            const cx = c.getContext('2d');
            
            if (type === 'grass') {
                const gradient = cx.createLinearGradient(0, 0, 0, VIEW_HEIGHT);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(0.6, '#98D8E8');
                gradient.addColorStop(0.6, '#5D8C3E');
                gradient.addColorStop(1, '#4A7C2F');
                cx.fillStyle = gradient;
                cx.fillRect(0, 0, VIEW_WIDTH, VIEW_HEIGHT);
                cx.fillStyle = 'rgba(74, 124, 47, 0.5)';
                for (let i = 0; i < 100; i++) {
                    const x = Math.random() * VIEW_WIDTH;
                    const y = VIEW_HEIGHT * 0.6 + Math.random() * VIEW_HEIGHT * 0.4;
                    cx.fillRect(x, y, 2, 3);
                }
            } else if (type === 'desert') {
                const gradient = cx.createLinearGradient(0, 0, 0, VIEW_HEIGHT);
                gradient.addColorStop(0, '#FFE4B5');
                gradient.addColorStop(0.5, '#F4D7B5');
                gradient.addColorStop(0.5, '#E6C89E');
                gradient.addColorStop(1, '#D4B896');
                cx.fillStyle = gradient;
                cx.fillRect(0, 0, VIEW_WIDTH, VIEW_HEIGHT);
                cx.fillStyle = 'rgba(194, 168, 136, 0.4)';
                cx.beginPath();
                cx.arc(VIEW_WIDTH * 0.3, VIEW_HEIGHT * 0.7, 60, 0, Math.PI, true);
                cx.fill();
                cx.beginPath();
                cx.arc(VIEW_WIDTH * 0.7, VIEW_HEIGHT * 0.75, 50, 0, Math.PI, true);
                cx.fill();
            } else if (type === 'dungeon') {
                const gradient = cx.createLinearGradient(0, 0, 0, VIEW_HEIGHT);
                gradient.addColorStop(0, '#1a1a2e');
                gradient.addColorStop(0.5, '#2c2c3e');
                gradient.addColorStop(1, '#3a3a4e');
                cx.fillStyle = gradient;
                cx.fillRect(0, 0, VIEW_WIDTH, VIEW_HEIGHT);
                cx.fillStyle = 'rgba(60, 60, 70, 0.5)';
                for (let i = 0; i < 50; i++) {
                    const x = Math.random() * VIEW_WIDTH;
                    const y = VIEW_HEIGHT * 0.6 + Math.random() * VIEW_HEIGHT * 0.4;
                    cx.fillRect(x, y, 4, 4);
                }
            }
            
            return c;
        }

        battleBackgrounds.grass = createBattleBackground('grass');
        battleBackgrounds.desert = createBattleBackground('desert');
        battleBackgrounds.dungeon = createBattleBackground('dungeon');

        // MAP & DUNGEON
        const map = Array(MAP_HEIGHT).fill().map(() => Array(MAP_WIDTH).fill(0));

        function generateDungeon(spawnDevilBoss = false) {
            for (let y = 0; y < MAP_HEIGHT; y++) {
                for (let x = 0; x < MAP_WIDTH; x++) {
                    map[y][x] = 10 + Math.floor(Math.random() * sprites.walls.length);
                }
            }

            const rooms = [];
            const numRooms = 10 + Math.floor(Math.random() * 5);
            
            for (let i = 0; i < numRooms; i++) {
                const w = 5 + Math.floor(Math.random() * 8);
                const h = 5 + Math.floor(Math.random() * 8);
                const x = 2 + Math.floor(Math.random() * (MAP_WIDTH - w - 4));
                const y = 2 + Math.floor(Math.random() * (MAP_HEIGHT - h - 4));
                const room = { x, y, w, h };

                let valid = true;
                for (let r of rooms) {
                    if (x < r.x + r.w + 2 && x + w + 2 > r.x && y < r.y + r.h + 2 && y + h + 2 > r.y) {
                        valid = false;
                        break;
                    }
                }
                
                if (valid) {
                    rooms.push(room);
                    for (let ry = y; ry < y + h; ry++) {
                        for (let rx = x; rx < x + w; rx++) {
                            map[ry][rx] = Math.floor(Math.random() * sprites.floors.length);
                        }
                    }
                }
            }

            for (let i = 0; i < rooms.length - 1; i++) {
                const r1 = rooms[i];
                const r2 = rooms[i + 1];
                const cx1 = r1.x + Math.floor(r1.w / 2);
                const cy1 = r1.y + Math.floor(r1.h / 2);
                const cx2 = r2.x + Math.floor(r2.w / 2);
                const cy2 = r2.y + Math.floor(r2.h / 2);

                for (let x = Math.min(cx1, cx2); x <= Math.max(cx1, cx2); x++) {
                    map[cy1][x] = Math.floor(Math.random() * sprites.floors.length);
                }
                for (let y = Math.min(cy1, cy2); y <= Math.max(cy1, cy2); y++) {
                    map[y][cx2] = Math.floor(Math.random() * sprites.floors.length);
                }
            }

            const startRoom = rooms[0];
            player.x = (startRoom.x + startRoom.w / 2) * TILE_SIZE;
            player.y = (startRoom.y + startRoom.h / 2) * TILE_SIZE;

            enemies.length = 0;
            pickups.length = 0;

            let enemyCount = 0;
            const minEnemies = spawnDevilBoss ? 1 : 2;

            for (let i = 1; i < rooms.length; i++) {
                const room = rooms[i];
                
                if (Math.random() < 0.5 + dungeonLevel * 0.05 || enemyCount < minEnemies) {
                    let vice;
                    
                    if (spawnDevilBoss && enemyCount === 0) {
                        vice = DEVIL_BOSS;
                    } else {
                        const availableVices = VICES.filter(v => 
                            !DEADLY_SINS.includes(v.name) || !defeatedSins.has(v.name)
                        );
                        if (availableVices.length === 0) continue;
                        const viceIndex = Math.floor(Math.random() * availableVices.length);
                        vice = availableVices[viceIndex];
                    }
                    
                    let ex, ey, attempts = 0;
                    do {
                        ex = Math.floor(room.x + 1 + Math.random() * (room.w - 2)) * TILE_SIZE;
                        ey = Math.floor(room.y + 1 + Math.random() * (room.h - 2)) * TILE_SIZE;
                        attempts++;
                    } while (collides(ex, ey) && attempts < 20);
                    
                    enemies.push({ x: ex, y: ey, vx: 0, vy: 0, speed: 3 + dungeonLevel * 0.5, vice: vice });
                    enemyCount++;
                }
                
                const numPicks = 1 + Math.floor(Math.random() * 3);
                for (let j = 0; j < numPicks; j++) {
                    if (Math.random() < 0.7) {
                        const px = (room.x + 1 + Math.random() * (room.w - 2)) * TILE_SIZE;
                        const py = (room.y + 1 + Math.random() * (room.h - 2)) * TILE_SIZE;
                        const typeRand = Math.random();
                        let type;
                        if (typeRand < 0.4) type = 'holyWater';
                        else if (typeRand < 0.7) type = 'rosary';
                        else type = 'gold';
                        pickups.push({ x: px, y: py, type });
                    }
                }
            }
        }

        const player = { x: TILE_SIZE * 5, y: TILE_SIZE * 5, vx: 0, vy: 0, speed: 80 };

        let enemies = [];
        let pickups = [];
        
        const inventory = { 
            holyWater: 3, 
            rosaries: 2,
            gold: 0,
            atkBoost: 0,
            defBoost: 0,
            hpBoost: 0,
            virtueItems: []
        };

        const VIRTUE_ITEMS = {
            "Pride": { name: "Cloak of Humility", effect: "DEF +5", defBoost: 5 },
            "Lust": { name: "Chastity Belt Armor", effect: "HP +50", hpBoost: 50 },
            "Wrath": { name: "Shield of Patience", effect: "DEF +10", defBoost: 10 },
            "Greed": { name: "Sword of Charity", effect: "ATK +8", atkBoost: 8 },
            "Envy": { name: "Boots of Kindness", effect: "SPD +2", spdBoost: 2 },
            "Gluttony": { name: "Ring of Temperance", effect: "HP +30", hpBoost: 30 },
            "Sloth": { name: "Gauntlets of Diligence", effect: "ATK +5", atkBoost: 5 }
        };

        const DEADLY_SINS = ['Pride', 'Greed', 'Lust', 'Envy', 'Gluttony', 'Wrath', 'Sloth'];
        let defeatedSins = new Set();
        
        const DEVIL_BOSS = {
            name: "The Devil",
            minion: "Demon",
            catechism: "The Devil and demons are fallen angels who rejected God. Through Christ's victory on the cross, Satan's power is broken. We must resist the devil through prayer, the sacraments, and faithful obedience to God.",
            verse: "The God of peace will soon crush Satan under your feet. The grace of our Lord Jesus be with you.",
            reference: "Romans 16:20"
        };
        
        const VICES = [
            { name: "Pride", minion: "Arrogance", catechism: "Pride is excessive love of one's own excellence. It is contrary to the virtue of humility and was the sin of Lucifer. The Church teaches that pride is the beginning of all sin.", verse: "Pride goes before destruction, a haughty spirit before a fall.", reference: "Proverbs 16:18" },
            { name: "Greed", minion: "Avarice", catechism: "Greed is the immoderate desire for earthly goods and the power they bring. The Catechism warns against making money an idol and teaches us to trust in God's providence.", verse: "The love of money is a root of all kinds of evil. Some people, eager for money, have wandered from the faith.", reference: "1 Timothy 6:10" },
            { name: "Lust", minion: "Desire", catechism: "Lust is disordered desire for sexual pleasure isolated from its unitive and procreative purposes. The Church calls us to chastity and purity of heart.", verse: "Flee from sexual immorality. All other sins a person commits are outside the body, but whoever sins sexually, sins against their own body.", reference: "1 Corinthians 6:18" },
            { name: "Envy", minion: "Jealousy", catechism: "Envy is sadness at another's good fortune and the immoderate desire to acquire goods for oneself. It is contrary to the tenth commandment and leads to malice.", verse: "A heart at peace gives life to the body, but envy rots the bones.", reference: "Proverbs 14:30" },
            { name: "Gluttony", minion: "Excess", catechism: "Gluttony is the immoderate desire for the pleasure of eating and drinking. The Church teaches moderation and self-control as fruits of the Holy Spirit.", verse: "Do not join those who drink too much wine or gorge themselves on meat, for drunkards and gluttons become poor.", reference: "Proverbs 23:20-21" },
            { name: "Wrath", minion: "Rage", catechism: "Anger becomes the sin of wrath when it is disproportionate to the offense and when it seeks revenge rather than justice. We are called to forgive as Christ forgave us.", verse: "Get rid of all bitterness, rage and anger, brawling and slander, along with every form of malice.", reference: "Ephesians 4:31" },
            { name: "Sloth", minion: "Apathy", catechism: "Sloth is spiritual laziness and neglect of divine grace. It shows itself in reluctance toward prayer, the sacraments, and works of charity.", verse: "The sluggard's craving will be the death of him, because his hands refuse to work.", reference: "Proverbs 21:25" }
        ];

        const heroes = [
            { name: "St. Vincent", hp: 100, maxHp: 100, mp: 30, maxMp: 30, atk: 15, def: 8, color: '#9b59b6' },
            { name: "St. Michael", hp: 120, maxHp: 120, mp: 25, maxMp: 25, atk: 18, def: 6, color: '#3498db' },
            { name: "St. Joan", hp: 110, maxHp: 110, mp: 35, maxMp: 35, atk: 14, def: 10, color: '#e74c3c' }
        ];

        const battle = {
            enemies: [],
            currentHeroIndex: 0,
            menuSelection: 0,
            targetSelection: 0,
            itemSelection: 0,
            phase: 'menu',
            log: [],
            shake: 0,
            flash: 0,
            isProcessing: false
        };

        const BATTLE_ACTIONS = ['Attack', 'Prayer', 'Item', 'Flee'];
        const ITEM_ACTIONS = ['Holy Water', 'Rosary', 'Back'];

        function startBattle(enemyObj) {
            gameState = 'battle';
            battle.isProcessing = false;
            
            const isFinalBoss = enemyObj.vice && enemyObj.vice.name === "The Devil";
            
            if (isFinalBoss && inventory.virtueItems.length === 7) {
                // Jesus uses the One Ring - instant win
                showOneRingVictory();
                return;
            }
            
            heroes.forEach(hero => {
                hero.hp = hero.maxHp + inventory.hpBoost;
                hero.mp = hero.maxMp;
                hero.atk = (hero.name === "St. Vincent" ? 15 : hero.name === "St. Michael" ? 18 : 14) + inventory.atkBoost;
                hero.def = (hero.name === "St. Vincent" ? 8 : hero.name === "St. Michael" ? 6 : 10) + inventory.defBoost;
            });
            
            let viceHp, minionHp, viceAtk, minionAtk;
            
            if (isFinalBoss) {
                viceHp = 200;
                minionHp = 100;
                viceAtk = 30;
                minionAtk = 20;
            } else {
                viceHp = 50 + dungeonLevel * 10;
                minionHp = 30 + dungeonLevel * 8;
                viceAtk = 15 + dungeonLevel * 2;
                minionAtk = 10 + dungeonLevel * 1;
            }
            
            battle.enemies = [
                { name: enemyObj.vice.name, hp: viceHp, maxHp: viceHp, atk: viceAtk, def: 4, isMinion: false, vice: enemyObj.vice },
                { name: enemyObj.vice.minion, hp: minionHp, maxHp: minionHp, atk: minionAtk, def: 2, isMinion: true, vice: enemyObj.vice }
            ];
            
            battle.currentHeroIndex = 0;
            battle.menuSelection = 0;
            battle.targetSelection = 0;
            battle.itemSelection = 0;
            battle.phase = 'menu';
            battle.log = [`Facing ${enemyObj.vice.name}!`, `${heroes[0].name}'s turn!`];
            battle.shake = 0;
            battle.flash = 0;
        }

        function showOneRingVictory() {
            document.getElementById('quote-text').innerHTML = `
                <div style="color: #f1c40f; font-size: 20px; font-weight: bold; margin-bottom: 12px;">
                    ⚡ THE ONE RING TO RULE THEM ALL! ⚡
                </div>
                <div style="color: #2ecc71; font-size: 15px; margin-bottom: 12px;">
                    Jesus Christ puts on the One Ring!<br>
                    Divine power destroys all evil instantly!
                </div>
                <div style="color: #e74c3c; font-size: 14px; margin-bottom: 12px;">
                    The Devil and all demons are vanquished in a single blow!
                </div>
                <div style="color: #ecf0f1; font-size: 12px; font-style: italic; line-height: 1.4; margin-bottom: 8px;">
                    "For I am convinced that neither death nor life, neither angels nor demons, 
                    nor anything else in all creation, will be able to separate us from the love 
                    of God that is in Christ Jesus our Lord."
                </div>
                <div style="color: #f39c12; font-size: 11px; font-weight: bold;">
                    — Romans 8:38-39
                </div>
            `;
            
            document.getElementById('quote-author').textContent = '';
            document.getElementById('quote-continue').textContent = 'New Game';
            document.getElementById('quote-overlay').style.display = 'flex';
            
            const continueBtn = document.getElementById('quote-continue');
            const handleContinue = () => {
                document.getElementById('quote-overlay').style.display = 'none';
                continueBtn.removeEventListener('click', handleContinue);
                continueBtn.removeEventListener('touchend', handleContinue);
                dungeonLevel = 1;
                defeatedSins.clear();
                inventory.holyWater = 3;
                inventory.rosaries = 2;
                inventory.gold = 0;
                inventory.atkBoost = 0;
                inventory.defBoost = 0;
                inventory.hpBoost = 0;
                inventory.virtueItems = [];
                generateDungeon();
                gameState = 'explore';
            };
            
            continueBtn.addEventListener('click', handleContinue);
            continueBtn.addEventListener('touchend', handleContinue);
        }

        function findNextAliveEnemy() {
            for (let i = 0; i < battle.enemies.length; i++) {
                if (battle.enemies[i].hp > 0) return i;
            }
            return 0;
        }

        function executeBattleAction() {
            if (battle.isProcessing) return;
            battle.isProcessing = true;
            
            const hero = heroes[battle.currentHeroIndex];
            const action = BATTLE_ACTIONS[battle.menuSelection];
            
            if (action === 'Attack') {
                const target = battle.enemies[battle.targetSelection];
                if (target.hp > 0) {
                    const damage = Math.max(1, hero.atk - target.def + Math.floor(Math.random() * 5));
                    target.hp -= damage;
                    battle.log.unshift(`${hero.name} deals ${damage} damage to ${target.name}!`);
                    battle.flash = 15;
                    battle.shake = 8;
                }
            } else if (action === 'Prayer') {
                if (hero.mp >= 10) {
                    const target = battle.enemies[battle.targetSelection];
                    if (target.hp > 0) {
                        const damage = Math.floor(hero.atk * 1.5) + Math.floor(Math.random() * 8);
                        target.hp -= damage;
                        hero.mp -= 10;
                        battle.log.unshift(`${hero.name} prays for ${damage} holy damage!`);
                        battle.flash = 20;
                        battle.shake = 10;
                    }
                } else {
                    battle.log.unshift(`${hero.name} lacks MP!`);
                }
            } else if (action === 'Flee') {
                if (Math.random() < 0.6) {
                    battle.log.unshift('Got away safely!');
                    setTimeout(() => {
                        battle.isProcessing = false;
                        gameState = 'explore';
                    }, 1000);
                    return;
                } else {
                    battle.log.unshift("Couldn't escape!");
                }
            }
            
            if (battle.log.length > 5) battle.log.pop();
            
            checkBattleEnd();
            if (gameState !== 'battle') {
                battle.isProcessing = false;
                return;
            }
            
            battle.currentHeroIndex++;
            if (battle.currentHeroIndex >= heroes.length) {
                battle.phase = 'enemyTurn';
                setTimeout(() => {
                    executeEnemyTurn();
                }, 800);
            } else {
                battle.phase = 'menu';
                battle.menuSelection = 0;
                battle.targetSelection = findNextAliveEnemy();
                battle.log.unshift(`${heroes[battle.currentHeroIndex].name}'s turn!`);
                if (battle.log.length > 5) battle.log.pop();
                battle.isProcessing = false;
            }
        }

        function useItem() {
            if (battle.isProcessing) return;
            battle.isProcessing = true;
            
            const hero = heroes[battle.currentHeroIndex];
            const item = ITEM_ACTIONS[battle.itemSelection];
            
            if (item === 'Holy Water') {
                if (inventory.holyWater > 0) {
                    hero.hp = Math.min(hero.maxHp + inventory.hpBoost, hero.hp + 50);
                    inventory.holyWater--;
                    battle.log.unshift(`${hero.name} drinks Holy Water! +50 HP`);
                } else {
                    battle.log.unshift('No Holy Water!');
                    battle.isProcessing = false;
                    return;
                }
            } else if (item === 'Rosary') {
                if (inventory.rosaries > 0) {
                    const damage = 30 + dungeonLevel * 5;
                    battle.enemies.forEach(enemy => {
                        if (enemy.hp > 0) {
                            enemy.hp -= damage;
                        }
                    });
                    inventory.rosaries--;
                    battle.log.unshift(`${hero.name} prays! Divine light strikes all foes!`);
                    battle.flash = 25;
                    battle.shake = 12;
                } else {
                    battle.log.unshift('No Rosary!');
                    battle.isProcessing = false;
                    return;
                }
            }
            
            if (battle.log.length > 5) battle.log.pop();
            
            checkBattleEnd();
            if (gameState !== 'battle') {
                battle.isProcessing = false;
                return;
            }
            
            battle.currentHeroIndex++;
            if (battle.currentHeroIndex >= heroes.length) {
                battle.phase = 'enemyTurn';
                setTimeout(() => {
                    executeEnemyTurn();
                }, 800);
            } else {
                battle.phase = 'menu';
                battle.menuSelection = 0;
                battle.itemSelection = 0;
                battle.targetSelection = findNextAliveEnemy();
                battle.log.unshift(`${heroes[battle.currentHeroIndex].name}'s turn!`);
                if (battle.log.length > 5) battle.log.pop();
                battle.isProcessing = false;
            }
        }

        function executeEnemyTurn() {
            let aliveEnemies = battle.enemies.filter(e => e.hp > 0);
            
            if (aliveEnemies.length === 0) {
                checkBattleEnd();
                return;
            }
            
            let enemyIndex = 0;
            
            function processNextEnemy() {
                if (gameState !== 'battle' || battle.phase !== 'enemyTurn') {
                    return;
                }
                
                if (enemyIndex >= aliveEnemies.length) {
                    checkBattleEnd();
                    if (gameState === 'battle') {
                        battle.currentHeroIndex = 0;
                        battle.phase = 'menu';
                        battle.menuSelection = 0;
                        battle.targetSelection = findNextAliveEnemy();
                        battle.log.unshift(`${heroes[0].name}'s turn!`);
                        if (battle.log.length > 5) battle.log.pop();
                        battle.isProcessing = false;
                    }
                    return;
                }
                
                const enemy = aliveEnemies[enemyIndex];
                const aliveHeroes = heroes.filter(h => h.hp > 0);
                
                if (aliveHeroes.length === 0) {
                    checkBattleEnd();
                    return;
                }
                
                const target = aliveHeroes[Math.floor(Math.random() * aliveHeroes.length)];
                const damage = Math.max(1, enemy.atk - target.def + Math.floor(Math.random() * 5));
                target.hp -= damage;
                
                battle.log.unshift(`${enemy.name} attacks ${target.name} for ${damage} damage!`);
                if (battle.log.length > 5) battle.log.pop();
                
                battle.shake = 6;
                battle.flash = 10;
                
                enemyIndex++;
                setTimeout(processNextEnemy, 1000);
            }
            
            processNextEnemy();
        }

        function checkBattleEnd() {
            if (heroes.every(h => h.hp <= 0)) {
                battle.log.unshift('All heroes defeated!');
                setTimeout(() => endBattle(false), 1500);
            } else if (battle.enemies.every(e => e.hp <= 0)) {
                battle.log.unshift(`Victory over ${battle.enemies[0].vice.name}!`);
                setTimeout(() => endBattle(true), 1500);
            }
        }

        function endBattle(won) {
            battle.isProcessing = false;
            
            if (won) {
                enemies = enemies.filter(e => e.vice !== battle.enemies[0].vice);
                
                const viceName = battle.enemies[0].vice.name;
                
                // Award virtue item if defeating a deadly sin
                if (DEADLY_SINS.includes(viceName) && !inventory.virtueItems.includes(viceName)) {
                    const virtueItem = VIRTUE_ITEMS[viceName];
                    inventory.virtueItems.push(viceName);
                    
                    if (virtueItem.atkBoost) inventory.atkBoost += virtueItem.atkBoost;
                    if (virtueItem.defBoost) inventory.defBoost += virtueItem.defBoost;
                    if (virtueItem.hpBoost) {
                        inventory.hpBoost += virtueItem.hpBoost;
                        heroes.forEach(h => h.maxHp += virtueItem.hpBoost);
                    }
                }
                
                if (viceName === "The Devil") {
                    showViceTeaching(battle.enemies[0].vice, () => {
                        showGameVictory();
                    });
                    return;
                }
                
                if (DEADLY_SINS.includes(viceName)) {
                    defeatedSins.add(viceName);
                    
                    if (defeatedSins.size >= 7) {
                        const virtueItem = VIRTUE_ITEMS[viceName];
                        showVirtueItemReceived(virtueItem, () => {
                            showViceTeaching(battle.enemies[0].vice, () => {
                                hudMsg = 'All Sins defeated! The Devil awaits...';
                                hudMsgTimer = 4;
                                dungeonLevel++;
                                generateDungeon(true);
                                gameState = 'explore';
                            });
                        });
                        return;
                    }
                }
                
                dungeonLevel++;
                
                if (DEADLY_SINS.includes(viceName)) {
                    const virtueItem = VIRTUE_ITEMS[viceName];
                    showVirtueItemReceived(virtueItem, () => {
                        showViceTeaching(battle.enemies[0].vice, () => {
                            hudMsg = `Victory! Level ${dungeonLevel}`;
                            hudMsgTimer = 3;
                            generateDungeon();
                            gameState = 'explore';
                        });
                    });
                } else {
                    showViceTeaching(battle.enemies[0].vice, () => {
                        hudMsg = `Victory! Level ${dungeonLevel}`;
                        hudMsgTimer = 3;
                        generateDungeon();
                        gameState = 'explore';
                    });
                }
            } else {
                dungeonLevel = 1;
                defeatedSins.clear();
                hudMsg = 'Defeated! Starting over...';
                hudMsgTimer = 3;
                inventory.holyWater = 3;
                inventory.rosaries = 2;
                inventory.gold = 0;
                inventory.atkBoost = 0;
                inventory.defBoost = 0;
                inventory.hpBoost = 0;
                inventory.virtueItems = [];
                generateDungeon();
                gameState = 'explore';
            }
        }

        function showVirtueItemReceived(item, callback) {
            document.getElementById('quote-text').innerHTML = `
                <div style="color: #2ecc71; font-size: 18px; font-weight: bold; margin-bottom: 12px;">
                    ✨ VIRTUE ITEM RECEIVED! ✨
                </div>
                <div style="color: #f39c12; font-size: 16px; margin-bottom: 10px;">
                    ${item.name}
                </div>
                <div style="color: #ecf0f1; font-size: 13px; margin-bottom: 12px;">
                    ${item.effect}
                </div>
                <div style="color: #95a5a6; font-size: 11px; line-height: 1.4;">
                    This sacred item strengthens your heroes for battles ahead!
                </div>
            `;
            
            document.getElementById('quote-author').textContent = '';
            document.getElementById('quote-overlay').style.display = 'flex';
            
            const continueBtn = document.getElementById('quote-continue');
            continueBtn.textContent = 'Continue';
            const handleContinue = () => {
                document.getElementById('quote-overlay').style.display = 'none';
                continueBtn.removeEventListener('click', handleContinue);
                continueBtn.removeEventListener('touchend', handleContinue);
                callback();
            };
            
            continueBtn.addEventListener('click', handleContinue);
            continueBtn.addEventListener('touchend', handleContinue);
        }

        function showGameVictory() {
            document.getElementById('quote-text').innerHTML = `
                <div style="color: #f1c40f; font-size: 20px; font-weight: bold; margin-bottom: 12px;">
                    🏆 VICTORY! 🏆
                </div>
                <div style="color: #2ecc71; font-size: 15px; margin-bottom: 12px;">
                    The Devil has been vanquished!<br>
                    Light triumphs over darkness!
                </div>
                <div style="color: #ecf0f1; font-size: 12px; font-style: italic; line-height: 1.4; margin-bottom: 8px;">
                    "For I am convinced that neither death nor life, neither angels nor demons, 
                    nor anything else in all creation, will be able to separate us from the love 
                    of God that is in Christ Jesus our Lord."
                </div>
                <div style="color: #f39c12; font-size: 11px; font-weight: bold;">
                    — Romans 8:38-39
                </div>
            `;
            
            document.getElementById('quote-author').textContent = '';
            document.getElementById('quote-continue').textContent = 'New Game';
            document.getElementById('quote-overlay').style.display = 'flex';
            
            const continueBtn = document.getElementById('quote-continue');
            const handleContinue = () => {
                document.getElementById('quote-overlay').style.display = 'none';
                continueBtn.removeEventListener('click', handleContinue);
                continueBtn.removeEventListener('touchend', handleContinue);
                dungeonLevel = 1;
                defeatedSins.clear();
                inventory.holyWater = 3;
                inventory.rosaries = 2;
                inventory.gold = 0;
                inventory.atkBoost = 0;
                inventory.defBoost = 0;
                inventory.hpBoost = 0;
                inventory.virtueItems = [];
                generateDungeon();
                gameState = 'explore';
            };
            
            continueBtn.addEventListener('click', handleContinue);
            continueBtn.addEventListener('touchend', handleContinue);
        }

        function wrapText(text, maxChars) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            for (let word of words) {
                if ((currentLine + word).length > maxChars && currentLine !== '') {
                    lines.push(currentLine.trim());
                    currentLine = word + ' ';
                } else {
                    currentLine += word + ' ';
                }
            }
            if (currentLine.trim() !== '') {
                lines.push(currentLine.trim());
            }
            
            return lines;
        }

        function showViceTeaching(vice, callback) {
            const catechismLines = wrapText(vice.catechism, 55);
            const verseLines = wrapText(vice.verse, 55);
            
            document.getElementById('quote-text').innerHTML = `
                <div style="color: #e74c3c; font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                    ${vice.name} Defeated!
                </div>
                <div style="color: #ecf0f1; font-size: 12px; line-height: 1.5; text-align: left; margin-bottom: 12px;">
                    ${catechismLines.join('<br>')}
                </div>
                <div style="color: #3498db; font-size: 11px; font-style: italic; line-height: 1.4; text-align: left; margin-bottom: 5px;">
                    "${verseLines.join('<br>')}"
                </div>
                <div style="color: #f39c12; font-size: 11px; font-weight: bold;">
                    — ${vice.reference}
                </div>
            `;
            
            document.getElementById('quote-author').textContent = '';
            document.getElementById('quote-continue').textContent = 'Continue';
            document.getElementById('quote-overlay').style.display = 'flex';
            
            const continueBtn = document.getElementById('quote-continue');
            const handleContinue = () => {
                document.getElementById('quote-overlay').style.display = 'none';
                continueBtn.removeEventListener('click', handleContinue);
                continueBtn.removeEventListener('touchend', handleContinue);
                callback();
            };
            
            continueBtn.addEventListener('click', handleContinue);
            continueBtn.addEventListener('touchend', handleContinue);
        }

        let invSelection = 0;

        function openInventory() {
            gameState = 'inventory';
            invSelection = 0;
        }

        const keys = {};
        const keyPressed = {};

        window.addEventListener('keydown', (e) => {
            const k = e.key.toLowerCase();
            if (!keys[k]) {
                keyPressed[k] = true;
            }
            keys[k] = true;
            
            if (k === 'z' && !keyPressed['enter']) {
                keyPressed['enter'] = true;
            }
            if (k === 'x' && !keyPressed['escape']) {
                keyPressed['escape'] = true;
            }
            
            if (gameState === 'title') {
                if (e.key === 'Enter' || k === 'z') {
                    gameState = 'explore';
                    generateDungeon();
                } else if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                    currentVerseIndex = e.key === 'ArrowRight' ? 
                        (currentVerseIndex + 1) % titleScreenVerses.length :
                        (currentVerseIndex + titleScreenVerses.length - 1) % titleScreenVerses.length;
                    verseTimer = VERSE_DISPLAY_TIME;
                }
            } else if (gameState === 'battle' && !battle.isProcessing) {
                if (battle.phase === 'menu') {
                    if (e.key === 'ArrowDown' || k === 's') {
                        battle.menuSelection = (battle.menuSelection + 1) % BATTLE_ACTIONS.length;
                    } else if (e.key === 'ArrowUp' || k === 'w') {
                        battle.menuSelection = (battle.menuSelection - 1 + BATTLE_ACTIONS.length) % BATTLE_ACTIONS.length;
                    } else if ((e.key === 'Enter' || k === 'z') && keyPressed['enter']) {
                        keyPressed['enter'] = false;
                        if (BATTLE_ACTIONS[battle.menuSelection] === 'Item') {
                            battle.phase = 'item';
                            battle.itemSelection = 0;
                        } else if (BATTLE_ACTIONS[battle.menuSelection] === 'Flee') {
                            executeBattleAction();
                        } else {
                            battle.phase = 'target';
                            battle.targetSelection = findNextAliveEnemy();
                        }
                    }
                } else if (battle.phase === 'target') {
                    if (e.key === 'ArrowDown' || k === 's') {
                        let next = battle.targetSelection + 1;
                        while (next < battle.enemies.length && battle.enemies[next].hp <= 0) {
                            next++;
                        }
                        if (next < battle.enemies.length) {
                            battle.targetSelection = next;
                        }
                    } else if (e.key === 'ArrowUp' || k === 'w') {
                        let prev = battle.targetSelection - 1;
                        while (prev >= 0 && battle.enemies[prev].hp <= 0) {
                            prev--;
                        }
                        if (prev >= 0) {
                            battle.targetSelection = prev;
                        }
                    } else if ((e.key === 'Enter' || k === 'z') && keyPressed['enter']) {
                        keyPressed['enter'] = false;
                        battle.phase = 'executing';
                        executeBattleAction();
                    } else if (e.key === 'Escape' || k === 'x') {
                        battle.phase = 'menu';
                    }
                } else if (battle.phase === 'item') {
                    if (e.key === 'ArrowDown' || k === 's') {
                        battle.itemSelection = (battle.itemSelection + 1) % ITEM_ACTIONS.length;
                    } else if (e.key === 'ArrowUp' || k === 'w') {
                        battle.itemSelection = (battle.itemSelection - 1 + ITEM_ACTIONS.length) % ITEM_ACTIONS.length;
                    } else if ((e.key === 'Enter' || k === 'z') && keyPressed['enter']) {
                        keyPressed['enter'] = false;
                        if (ITEM_ACTIONS[battle.itemSelection] === 'Back') {
                            battle.phase = 'menu';
                        } else {
                            battle.phase = 'executing';
                            useItem();
                        }
                    } else if (e.key === 'Escape' || k === 'x') {
                        battle.phase = 'menu';
                    }
                }
            } else if (gameState === 'inventory') {
                if (e.key === 'ArrowDown' || k === 's') {
                    invSelection = Math.min(2 + inventory.virtueItems.length, invSelection + 1);
                } else if (e.key === 'ArrowUp' || k === 'w') {
                    invSelection = Math.max(0, invSelection - 1);
                } else if (e.key === 'Escape' || k === 'x' || k === 'i') {
                    gameState = 'explore';
                }
            } else if (gameState === 'explore') {
                if (k === 'i' || (keyPressed['start'] && !keys['start'])) {
                    openInventory();
                    keyPressed['start'] = false;
                }
            }
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
            if (e.key.toLowerCase() === 'z') keyPressed['enter'] = false;
            if (e.key.toLowerCase() === 'x') keyPressed['escape'] = false;
        });

        function setupTouchControls() {
            const keyMap = {
                'arrowup': 'ArrowUp',
                'arrowdown': 'ArrowDown',
                'arrowleft': 'ArrowLeft',
                'arrowright': 'ArrowRight'
            };

            document.querySelectorAll('.dpad-btn:not(.center)').forEach(btn => {
                const key = btn.dataset.key;
                
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    keys[key] = true;
                    keyPressed[key] = true;
                    const dispatchKey = keyMap[key] || key;
                    const event = new KeyboardEvent('keydown', { key: dispatchKey });
                    window.dispatchEvent(event);
                });
                
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    keys[key] = false;
                    keyPressed[key] = false;
                    const dispatchKey = keyMap[key] || key;
                    const event = new KeyboardEvent('keyup', { key: dispatchKey });
                    window.dispatchEvent(event);
                });
            });
            
            document.querySelectorAll('.game-btn, .start-btn').forEach(btn => {
                const key = btn.dataset.key;
                
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    
                    if (key === 'start') {
                        if (gameState === 'explore') {
                            openInventory();
                        }
                    } else if (key === 'a') {
                        keyPressed['enter'] = true;
                        const enterEvent = new KeyboardEvent('keydown', { key: 'Enter' });
                        window.dispatchEvent(enterEvent);
                    } else if (key === 'b') {
                        keyPressed['escape'] = true;
                        const escEvent = new KeyboardEvent('keydown', { key: 'Escape' });
                        window.dispatchEvent(escEvent);
                    }
                });
                
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    if (key === 'a') keyPressed['enter'] = false;
                    if (key === 'b') keyPressed['escape'] = false;
                });
            });
        }

        function collides(x, y) {
            const tx = Math.floor(x / TILE_SIZE);
            const ty = Math.floor(y / TILE_SIZE);
            if (tx < 0 || tx >= MAP_WIDTH || ty < 0 || ty >= MAP_HEIGHT) return true;
            return map[ty][tx] >= 10;
        }

        function getEnemySprite(viceName, isMinion) {
            if (viceName === "The Devil") {
                return isMinion ? sprites.demon : sprites.devil;
            }
            
            const spriteMap = {
                "Pride": sprites.pride,
                "Greed": sprites.greed,
                "Lust": sprites.lust,
                "Envy": sprites.envy,
                "Gluttony": sprites.gluttony,
                "Wrath": sprites.wrath,
                "Sloth": sprites.sloth
            };
            
            return isMinion ? sprites.enemy : (spriteMap[viceName] || sprites.enemy);
        }

        function update(dt) {
            battle.shake *= 0.85;
            battle.flash = Math.max(0, battle.flash - dt * 80);
            hudMsgTimer = Math.max(0, hudMsgTimer - dt);

            if (gameState === 'title') {
                verseTimer -= dt;
                if (verseTimer <= 0) {
                    currentVerseIndex = (currentVerseIndex + 1) % titleScreenVerses.length;
                    verseTimer = VERSE_DISPLAY_TIME;
                }
            } else if (gameState === 'explore') {
                player.vx = 0;
                player.vy = 0;
                
                if (keys['w'] || keys['arrowup']) player.vy = -player.speed;
                if (keys['s'] || keys['arrowdown']) player.vy = player.speed;
                if (keys['a'] || keys['arrowleft']) player.vx = -player.speed;
                if (keys['d'] || keys['arrowright']) player.vx = player.speed;

                const speed = Math.hypot(player.vx, player.vy);
                if (speed > 0.1) {
                    player.vx = (player.vx / speed) * player.speed;
                    player.vy = (player.vy / speed) * player.speed;
                }

                const nextX = player.x + player.vx * dt;
                const nextY = player.y + player.vy * dt;
                
                if (!collides(nextX, player.y) && !collides(nextX + TILE_SIZE - 1, player.y)) {
                    player.x = nextX;
                }
                if (!collides(player.x, nextY) && !collides(player.x, nextY + TILE_SIZE - 1)) {
                    player.y = nextY;
                }

                for (let i = pickups.length - 1; i >= 0; i--) {
                    const p = pickups[i];
                    const dx = player.x - p.x;
                    const dy = player.y - p.y;
                    
                    if (Math.hypot(dx, dy) < TILE_SIZE) {
                        if (p.type === 'holyWater') {
                            inventory.holyWater++;
                            const hpIncrease = 10;
                            inventory.hpBoost += hpIncrease;
                            heroes.forEach(h => h.maxHp += hpIncrease);
                            hudMsg = `Holy Water! +${hpIncrease} Max HP!`;
                        } else if (p.type === 'rosary') {
                            inventory.rosaries++;
                            const atkIncrease = 2;
                            inventory.atkBoost += atkIncrease;
                            hudMsg = `Rosary! +${atkIncrease} ATK!`;
                        } else if (p.type === 'gold') {
                            const goldAmount = 10 + Math.floor(Math.random() * 20);
                            inventory.gold += goldAmount;
                            hudMsg = `Found ${goldAmount} Gold!`;
                        }
                        hudMsgTimer = 2;
                        pickups.splice(i, 1);
                    }
                }

                for (let e of enemies) {
                    const nextEX = e.x + e.vx * dt;
                    const nextEY = e.y + e.vy * dt;

                    if (!collides(nextEX, nextEY)) {
                        e.x = nextEX;
                        e.y = nextEY;
                    } else {
                        const angle = Math.random() * Math.PI * 2;
                        e.vx = Math.cos(angle) * e.speed;
                        e.vy = Math.sin(angle) * e.speed;
                    }

                    if (Math.random() < dt * 2) {
                        const angle = Math.random() * Math.PI * 2;
                        e.vx = Math.cos(angle) * e.speed;
                        e.vy = Math.sin(angle) * e.speed;
                    }

                    const dx = player.x - e.x;
                    const dy = player.y - e.y;
                    if (Math.hypot(dx, dy) < TILE_SIZE * 1.5) {
                        startBattle(e);
                        break;
                    }
                }
            }
        }

        function render() {
            ctx.save();
            ctx.scale(SCALE, SCALE);
            ctx.clearRect(0, 0, VIEW_WIDTH, VIEW_HEIGHT);

            if (gameState === 'title') {
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, VIEW_WIDTH, VIEW_HEIGHT);
                
                ctx.fillStyle = '#f39c12';
                ctx.font = 'bold 16px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('THE SEVEN HEAVENLY', VIEW_WIDTH/2, 25);
                ctx.fillText('VIRTUES', VIEW_WIDTH/2, 40);
                
                ctx.font = 'bold 11px monospace';
                ctx.fillStyle = '#9b59b6';
                ctx.fillText('Battle Against Sin & Death', VIEW_WIDTH/2, 55);
                
                const verse = titleScreenVerses[currentVerseIndex];
                ctx.font = '8px monospace';
                ctx.fillStyle = '#ecf0f1';
                
                const lines = wrapText(verse.text, 50);
                let y = 80;
                for (let line of lines) {
                    ctx.fillText(line, VIEW_WIDTH/2, y);
                    y += 11;
                }
                
                ctx.fillStyle = '#f39c12';
                ctx.font = 'bold 9px monospace';
                ctx.fillText(`— ${verse.reference}`, VIEW_WIDTH/2, y + 10);
                
                ctx.fillStyle = '#95a5a6';
                ctx.font = '7px monospace';
                ctx.fillText(`Verse ${currentVerseIndex + 1} of ${titleScreenVerses.length} (← →)`, VIEW_WIDTH/2, VIEW_HEIGHT - 40);
                
                ctx.fillStyle = '#2ecc71';
                ctx.font = 'bold 10px monospace';
                ctx.fillText('Press ENTER or Z to Begin', VIEW_WIDTH/2, VIEW_HEIGHT - 20);
                
                ctx.textAlign = 'left';
                
            } else if (gameState === 'explore') {
                const camX = Math.floor(player.x - VIEW_WIDTH / 2 + TILE_SIZE / 2);
                const camY = Math.floor(player.y - VIEW_HEIGHT / 2 + TILE_SIZE / 2);

                const startX = Math.max(0, Math.floor(camX / TILE_SIZE));
                const endX = Math.min(MAP_WIDTH, Math.ceil((camX + VIEW_WIDTH) / TILE_SIZE));
                const startY = Math.max(0, Math.floor(camY / TILE_SIZE));
                const endY = Math.min(MAP_HEIGHT, Math.ceil((camY + VIEW_HEIGHT) / TILE_SIZE));

                for (let ty = startY; ty < endY; ty++) {
                    for (let tx = startX; tx < endX; tx++) {
                        const tileIdx = map[ty][tx];
                        const sprite = tileIdx >= 10 ? sprites.walls[tileIdx - 10] : sprites.floors[tileIdx];
                        ctx.drawImage(sprite, tx * TILE_SIZE - camX, ty * TILE_SIZE - camY);
                    }
                }

                for (let p of pickups) {
                    ctx.drawImage(sprites[p.type], p.x - camX, p.y - camY);
                }

                for (let e of enemies) {
                    const enemySprite = getEnemySprite(e.vice.name, false);
                    ctx.drawImage(enemySprite, e.x - camX, e.y - camY);
                    if (e.vice) {
                        ctx.fillStyle = '#e74c3c';
                        ctx.font = 'bold 6px monospace';
                        ctx.textAlign = 'center';
                        ctx.fillText(e.vice.name.toUpperCase(), e.x - camX + 8, e.y - camY - 2);
                    }
                }

                ctx.drawImage(sprites.player, player.x - camX, player.y - camY);

                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(5, 5, 115, 50);
                ctx.fillStyle = '#f39c12';
                ctx.font = '9px monospace';
                ctx.textAlign = 'left';
                ctx.fillText(`Level: ${dungeonLevel}`, 10, 15);
                ctx.fillText(`Sins: ${defeatedSins.size}/7`, 10, 26);
                ctx.fillText(`Virtues: ${inventory.virtueItems.length}/7`, 10, 37);
                ctx.fillStyle = '#3498db';
                ctx.fillText(`Water: ${inventory.holyWater}`, 10, 48);
                ctx.fillStyle = '#8b4513';
                ctx.fillText(`Rosary: ${inventory.rosaries}`, 65, 48);

                if (hudMsgTimer > 0) {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.fillRect(VIEW_WIDTH/2 - 70, 10, 140, 20);
                    ctx.fillStyle = '#2ecc71';
                    ctx.textAlign = 'center';
                    ctx.font = '8px monospace';
                    ctx.fillText(hudMsg, VIEW_WIDTH/2, 20);
                }
                
            } else if (gameState === 'battle') {
                const bgTypes = ['grass', 'desert', 'dungeon'];
                const bgType = bgTypes[Math.min(Math.floor((dungeonLevel - 1) / 3), 2)];
                ctx.drawImage(battleBackgrounds[bgType], 0, 0);

                ctx.save();
                if (battle.shake > 0) {
                    ctx.translate(
                        (Math.random() - 0.5) * battle.shake,
                        (Math.random() - 0.5) * battle.shake
                    );
                }

                if (battle.flash > 0) {
                    ctx.globalAlpha = Math.min(0.5, battle.flash / 40);
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, VIEW_WIDTH, VIEW_HEIGHT);
                    ctx.globalAlpha = 1;
                }

                const heroX = 30;
                const heroStartY = 60;
                const heroSpacing = 25;
                
                for (let i = 0; i < heroes.length; i++) {
                    const hero = heroes[i];
                    const y = heroStartY + i * heroSpacing;
                    
                    if (i === battle.currentHeroIndex && battle.phase !== 'enemyTurn') {
                        ctx.fillStyle = 'rgba(46, 204, 113, 0.3)';
                        ctx.fillRect(heroX - 5, y - 5, 100, 24);
                    }
                    
                    const heroSprites = {
                        "St. Michael": sprites.stMichael,
                        "St. Joan": sprites.stJoan,
                        "St. Vincent": sprites.stVincent
                    };
                    ctx.drawImage(heroSprites[hero.name] || sprites.player, heroX, y);
                    
                    ctx.fillStyle = hero.color;
                    ctx.font = 'bold 8px monospace';
                    ctx.textAlign = 'left';
                    ctx.fillText(hero.name, heroX + 20, y + 2);
                    
                    ctx.fillStyle = '#34495e';
                    ctx.fillRect(heroX + 20, y + 10, 70, 5);
                    const hpPercent = hero.hp / (hero.maxHp + inventory.hpBoost);
                    ctx.fillStyle = hpPercent > 0.5 ? '#2ecc71' : hpPercent > 0.25 ? '#f39c12' : '#e74c3c';
                    ctx.fillRect(heroX + 20, y + 10, 70 * Math.max(0, hpPercent), 5);
                    
                    ctx.fillStyle = '#fff';
                    ctx.font = '7px monospace';
                    ctx.fillText(`${Math.max(0, hero.hp)}/${hero.maxHp + inventory.hpBoost}`, heroX + 95, y + 14);
                }

                const enemyX = VIEW_WIDTH - 80;
                const enemyStartY = 70;
                const enemySpacing = 30;
                
                for (let i = 0; i < battle.enemies.length; i++) {
                    const enemy = battle.enemies[i];
                    const y = enemyStartY + i * enemySpacing;
                    
                    if (enemy.hp > 0) {
                        if (i === battle.targetSelection && battle.phase === 'target') {
                            ctx.fillStyle = 'rgba(231, 76, 60, 0.3)';
                            ctx.fillRect(enemyX - 5, y - 5, 75, 24);
                        }
                        
                        const enemySprite = getEnemySprite(enemy.vice.name, enemy.isMinion);
                        ctx.drawImage(enemySprite, enemyX, y);
                        
                        ctx.fillStyle = '#e74c3c';
                        ctx.font = 'bold 8px monospace';
                        ctx.textAlign = 'right';
                        ctx.fillText(enemy.name, enemyX - 5, y + 5);
                        
                        ctx.fillStyle = '#34495e';
                        ctx.fillRect(enemyX - 60, y + 10, 55, 5);
                        ctx.fillStyle = '#e74c3c';
                        ctx.fillRect(enemyX - 60, y + 10, 55 * (enemy.hp / enemy.maxHp), 5);
                    } else {
                        ctx.fillStyle = 'rgba(149, 165, 166, 0.5)';
                        ctx.font = 'bold 7px monospace';
                        ctx.textAlign = 'right';
                        ctx.fillText('DEFEATED', enemyX - 5, y + 8);
                    }
                }

                ctx.fillStyle = 'rgba(22, 33, 62, 0.95)';
                ctx.fillRect(0, VIEW_HEIGHT - 50, VIEW_WIDTH, 50);
                
                if (battle.phase === 'menu') {
                    const btnWidth = 50;
                    const btnStartX = 20;
                    const btnY = VIEW_HEIGHT - 38;
                    
                    for (let i = 0; i < BATTLE_ACTIONS.length; i++) {
                        const btnX = btnStartX + i * (btnWidth + 5);
                        
                        ctx.fillStyle = i === battle.menuSelection ? '#f39c12' : '#34495e';
                        ctx.fillRect(btnX, btnY, btnWidth, 20);
                        
                        ctx.fillStyle = '#fff';
                        ctx.font = '8px monospace';
                        ctx.textAlign = 'center';
                        ctx.fillText(BATTLE_ACTIONS[i], btnX + btnWidth/2, btnY + 12);
                    }
                    
                    ctx.fillStyle = '#95a5a6';
                    ctx.font = '7px monospace';
                    ctx.textAlign = 'left';
                    ctx.fillText('↑↓ Select | Z Confirm', 20, VIEW_HEIGHT - 10);
                    
                } else if (battle.phase === 'target') {
                    ctx.fillStyle = '#fff';
                    ctx.font = '9px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText('Select Target', VIEW_WIDTH/2, VIEW_HEIGHT - 35);
                    
                    ctx.fillStyle = '#95a5a6';
                    ctx.font = '7px monospace';
                    ctx.fillText('↑↓ Select | Z Confirm | X Back', VIEW_WIDTH/2, VIEW_HEIGHT - 10);
                    
                } else if (battle.phase === 'item') {
                    const btnWidth = 60;
                    const btnStartX = 60;
                    const btnY = VIEW_HEIGHT - 38;
                    
                    for (let i = 0; i < ITEM_ACTIONS.length; i++) {
                        const btnX = btnStartX + i * (btnWidth + 5);
                        
                        ctx.fillStyle = i === battle.itemSelection ? '#f39c12' : '#34495e';
                        ctx.fillRect(btnX, btnY, btnWidth, 20);
                        
                        ctx.fillStyle = '#fff';
                        ctx.font = '8px monospace';
                        ctx.textAlign = 'center';
                        let label = ITEM_ACTIONS[i];
                        if (i === 0) label += ` (${inventory.holyWater})`;
                        if (i === 1) label += ` (${inventory.rosaries})`;
                        ctx.fillText(label, btnX + btnWidth/2, btnY + 12);
                    }
                    
                    ctx.fillStyle = '#95a5a6';
                    ctx.font = '7px monospace';
                    ctx.textAlign = 'left';
                    ctx.fillText('↑↓ Select | Z Confirm | X Back', 20, VIEW_HEIGHT - 10);
                }
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(10, 15, VIEW_WIDTH - 20, 40);
                ctx.fillStyle = '#ecf0f1';
                ctx.font = '8px monospace';
                ctx.textAlign = 'left';
                for (let i = 0; i < Math.min(4, battle.log.length); i++) {
                    ctx.fillText(battle.log[i], 15, 25 + i * 10);
                }

                if (dungeonLevel === 1 && battle.phase === 'menu') {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.fillRect(VIEW_WIDTH/2 - 80, 5, 160, 35);
                    ctx.fillStyle = '#f39c12';
                    ctx.font = '7px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText('BATTLE TUTORIAL', VIEW_WIDTH/2, 13);
                    ctx.fillStyle = '#fff';
                    ctx.font = '6px monospace';
                    ctx.fillText('↑↓: Select action', VIEW_WIDTH/2, 22);
                    ctx.fillText('Z/Enter: Confirm', VIEW_WIDTH/2, 30);
                    ctx.fillText('X/Esc: Back', VIEW_WIDTH/2, 38);
                }

                ctx.restore();
                
            } else if (gameState === 'inventory') {
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, VIEW_WIDTH, VIEW_HEIGHT);
                
                ctx.fillStyle = '#f39c12';
                ctx.font = 'bold 14px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('INVENTORY', VIEW_WIDTH/2, 20);
                
                ctx.font = '10px monospace';
                ctx.textAlign = 'left';
                
                const items = [
                    { name: 'Holy Water', value: inventory.holyWater, desc: `+50 HP, +10 Max HP per pickup` },
                    { name: 'Rosary', value: inventory.rosaries, desc: `AOE attack, +2 ATK per pickup` },
                    { name: 'Gold', value: inventory.gold, desc: 'Currency for future shops' }
                ];
                
                for (let i = 0; i < items.length; i++) {
                    const y = 40 + i * 30;
                    
                    ctx.fillStyle = i === invSelection ? 'rgba(243, 156, 18, 0.3)' : 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(15, y, VIEW_WIDTH - 30, 26);
                    
                    ctx.fillStyle = '#fff';
                    ctx.fillText(`${items[i].name}: ${items[i].value}`, 25, y + 12);
                    ctx.fillStyle = '#95a5a6';
                    ctx.font = '8px monospace';
                    ctx.fillText(items[i].desc, 25, y + 22);
                    ctx.font = '10px monospace';
                }
                
                if (inventory.virtueItems.length > 0) {
                    ctx.fillStyle = '#2ecc71';
                    ctx.font = 'bold 11px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText('VIRTUE ITEMS:', VIEW_WIDTH/2, 140);
                    
                    ctx.font = '8px monospace';
                    ctx.textAlign = 'left';
                    let vY = 150;
                    for (let sinName of inventory.virtueItems) {
                        const item = VIRTUE_ITEMS[sinName];
                        const selected = invSelection === (3 + inventory.virtueItems.indexOf(sinName));
                        
                        ctx.fillStyle = selected ? 'rgba(46, 204, 113, 0.3)' : 'rgba(0, 0, 0, 0.3)';
                        ctx.fillRect(15, vY, VIEW_WIDTH - 30, 18);
                        
                        ctx.fillStyle = '#f39c12';
                        ctx.fillText(`${item.name} - ${item.effect}`, 25, vY + 12);
                        vY += 20;
                    }
                }
                
                ctx.fillStyle = '#95a5a6';
                ctx.font = '8px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('Press X or I to close', VIEW_WIDTH/2, VIEW_HEIGHT - 10);
            }

            ctx.restore();
        }

        let lastTime = performance.now();
        function gameLoop(currentTime) {
            const dt = Math.min(0.033, (currentTime - lastTime) / 1000);
            lastTime = currentTime;
            
            update(dt);
            render();
            
            requestAnimationFrame(gameLoop);
        }

        function init() {
            console.log('The Seven Heavenly Virtues initialized!');
            setupTouchControls();
            verseTimer = VERSE_DISPLAY_TIME;
            requestAnimationFrame(gameLoop);
        }

        init();
    </script>
</body>
</html>
